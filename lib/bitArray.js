"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

// Generated by CoffeeScript 2.5.1
(function () {
  var BitArray, invalidArg, tooManyArgs;

  var _require = require('./utils');

  var _require$err = _require.err;
  invalidArg = _require$err.invalidArg;
  tooManyArgs = _require$err.tooManyArgs;

  BitArray = /*#__PURE__*/function () {
    function BitArray(arg1, arg2) {
      _classCallCheck(this, BitArray);

      var collection, i, j, len, mask, ref;

      if (Array.isArray(arg1)) {
        // it's private constructor
        this._collection = arg1;
        this._mask = arg2;
      } else {
        if (!(_typeof(arg1) === 'object' && arg1 !== null && arg1.hasOwnProperty('$$list'))) {
          invalidArg('arg1', arg1);
        }

        if (!(arguments.length <= 1)) {
          tooManyArgs();
        }

        this._collection = collection = arg1.hasOwnProperty('$$flat') ? arg1.$$flat.$$list : arg1.$$list;
        this._mask = mask = new Array(len = Math.trunc((collection.length + 31) / 32)); // constructor:

        for (i = j = 0, ref = len; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
          mask[i] = 0;
        }
      }

      return;
    }

    _createClass(BitArray, [{
      key: "set",
      value: function set(index, value) {
        var m;

        if (!(typeof index === 'number' && index % 1 === 0)) {
          invalidArg('index');
        }

        if (value === void 0) {
          value = true;
        } else {
          if (typeof value !== 'boolean') {
            invalidArg('value', value);
          }
        }

        if (!(arguments.length <= 2)) {
          tooManyArgs();
        }

        if (this.hasOwnProperty('_list')) {
          throw new Error("set() is not allowed in this state");
        }

        if (!(0 <= index && index < this._collection.length)) {
          throw new Error("index out of range: ".concat(index));
        }

        m = 1 << index % 32;

        if (value) {
          this._mask[Math.trunc(index / 32)] |= m;
        } else {
          this._mask[Math.trunc(index / 32)] &= ~m;
        }

        return this;
      }
    }, {
      key: "get",
      value: function get(index) {
        var value;

        if (!(typeof index === 'number' && index % 1 === 0)) {
          invalidArg('index');
        }

        if (value === void 0) {
          value = true;
        }

        if (!(arguments.length <= 1)) {
          tooManyArgs();
        }

        if (!(0 <= index && index < this._collection.length)) {
          throw new Error("index out of range: ".concat(index));
        }

        return (this._mask[Math.trunc(index / 32)] & 1 << index % 32) !== 0; // get:
      }
    }, {
      key: "and",
      value: function and(bitArray) {
        var collection, i, j, leftMask, len, ref, resMask, rightMask;

        if (!(_typeof(bitArray) === 'object' && bitArray !== null && bitArray.hasOwnProperty('_mask'))) {
          invalidArg('bitArray', bitArray);
        }

        if (!(arguments.length <= 1)) {
          tooManyArgs();
        }

        if (this._collection !== (collection = bitArray._collection)) {
          throw new Error('given bitArray is different collection');
        }

        resMask = new Array(len = (leftMask = this._mask).length);
        rightMask = bitArray._mask;

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          resMask[i] = leftMask[i] & rightMask[i];
        }

        return new BitArray(collection, resMask); // and:
      }
    }, {
      key: "or",
      value: function or(bitArray) {
        var collection, i, j, leftMask, len, ref, resMask, rightMask;

        if (!(_typeof(bitArray) === 'object' && bitArray !== null && bitArray.hasOwnProperty('_mask'))) {
          invalidArg('bitArray', bitArray);
        }

        if (!(arguments.length <= 1)) {
          tooManyArgs();
        }

        if (this._collection !== (collection = bitArray._collection)) {
          throw new Error('given bitArray is different collection');
        }

        resMask = new Array(len = (leftMask = this._mask).length);
        rightMask = bitArray._mask;

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          resMask[i] = leftMask[i] | rightMask[i];
        }

        return new BitArray(collection, resMask); // and:
      }
    }, {
      key: "subtract",
      value: function subtract(bitArray) {
        var collection, i, j, leftMask, len, ref, resMask, rightMask;

        if (!(_typeof(bitArray) === 'object' && bitArray !== null && bitArray.hasOwnProperty('_mask'))) {
          invalidArg('bitArray', bitArray);
        }

        if (!(arguments.length <= 1)) {
          tooManyArgs();
        }

        if (this._collection !== (collection = bitArray._collection)) {
          throw new Error('given bitArray is different collection');
        }

        resMask = new Array(len = (leftMask = this._mask).length);
        rightMask = bitArray._mask;

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          resMask[i] = leftMask[i] & ~rightMask[i];
        }

        return new BitArray(collection, resMask); // and:
      }
    }, {
      key: "invert",
      value: function invert() {
        var i, j, leftMask, len, r, ref, resMask;

        if (arguments.length !== 0) {
          tooManyArgs();
        }

        resMask = new Array(len = (leftMask = this._mask).length);

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          resMask[i] = ~leftMask[i];
        }

        if ((r = this._collection.length % 32) > 0) {
          resMask[len - 1] &= (1 << r) - 1;
        }

        return new BitArray(this._collection, resMask); // and:
      }
    }, {
      key: "isEmpty",
      value: function isEmpty() {
        var j, len1, ref, v;
        ref = this._mask;

        for (j = 0, len1 = ref.length; j < len1; j++) {
          v = ref[j];

          if (v !== 0) {
            return false;
          }
        }

        return true; // isEmpty:
      }
    }, {
      key: "fixVertical",
      value: function fixVertical() {
        var i, item, itemMask, j, k, l, len1, mask, noSubfields, ref, ref1, ref2;
        ref = this._collection;

        for (j = 0, len1 = ref.length; j < len1; j++) {
          item = ref[j];

          if (!item.hasOwnProperty('$$mask')) {
            continue;
          }

          itemMask = item.$$mask._mask;
          mask = this._mask;
          noSubfields = true;

          for (i = k = 0, ref1 = mask.length; k < ref1; i = k += 1) {
            if (!((mask[i] & itemMask[i]) !== 0)) {
              continue;
            }

            noSubfields = false;
            break;
          }

          if (this.get(item.$$index)) {
            if (noSubfields) {
              for (i = l = 0, ref2 = mask.length; l < ref2; i = l += 1) {
                mask[i] |= itemMask[i];
              }
            }
          } else if (!noSubfields) {
            this.set(item.$$index); // fixVertical:
          }
        }
      }
    }, {
      key: "clearVertical",
      value: function clearVertical() {
        var i, item, itemMask, j, k, mask, noSubfields, ref, ref1;
        ref = this._collection;

        for (j = ref.length - 1; j >= 0; j += -1) {
          item = ref[j];

          if (!item.hasOwnProperty('$$mask')) {
            continue;
          }

          itemMask = item.$$mask._mask;
          mask = this._mask;
          noSubfields = true;

          for (i = k = 0, ref1 = mask.length; k < ref1; i = k += 1) {
            if (!((mask[i] & itemMask[i]) !== 0)) {
              continue;
            }

            noSubfields = false;
            break;
          }

          this.set(item.$$index, !noSubfields); // clearVertical:
        }
      }
    }, {
      key: "valueOf",
      value: function valueOf() {
        var collection, i, j, len, m, mask, p, ref, res, v;
        res = [];
        len = (collection = this._collection).length;
        m = 1;
        v = (mask = this._mask)[p = 0];

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          if ((v & m) !== 0) {
            res.push(i);
          }

          if ((m <<= 1) === 0) {
            m = 1;
            v = mask[++p];
          }
        }

        return res; // valueOf:
      }
    }]);

    return BitArray;
  }();

  Object.defineProperty(BitArray.prototype, 'list', {
    configurable: true,
    enumerable: true,
    get: function get() {
      var collection, i, j, len, list, m, mask, p, ref, v;

      if (!this.hasOwnProperty('_list')) {
        this._list = list = [];
        len = (collection = this._collection).length;
        m = 1;
        v = (mask = this._mask)[p = 0];

        for (i = j = 0, ref = len; j < ref; i = j += 1) {
          if ((v & m) !== 0) {
            list.push(collection[i]);
          }

          if ((m <<= 1) === 0) {
            m = 1;
            v = mask[++p];
          }
        }
      }

      return this._list; // get: ->
    }
  }); // ----------------------------

  module.exports = BitArray;
}).call(void 0);